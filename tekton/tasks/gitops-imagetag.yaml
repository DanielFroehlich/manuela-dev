apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: gitops-imagetag
spec:
  inputs:
    params:
    - name: GIT_USERNAME
      description: The username to be used for the git commit.
      type: string
      default: "manuela-tekton"
    - name: GIT_EMAIL
      description: The email to be used for the git commit.
      type: string
      default: "manuela-team@redhat.com"
    - name: GIT_COMMENT
      description: The comment to be used for the git commit.
      type: string
      default: "Image tag updated by Tekton task gitops-imagetag"
    - name: GIT_BRANCH
      description: The branch to create / use
      type: string
      default: approve
    - name: RESOURCE_PATH
      description: The path of the resource to be patched.
      type: string
      default: "config/instances/manuela-tst/kustomization.yaml"
    - name: YAML_PATH
      description: the yq yaml path of the value to be changed
      type: string
      default: images.(name==line-dashboard).newTag
    resources:
    - name: source-gitops
      type: git
    - name: source-semver
      type: git  
  steps:
  - name: checkout-branch-and-merge-master
    image: alpine/git
    script: |
        #!/usr/bin/env sh
        if [ "$(inputs.params.GIT_BRANCH)" != "$(resources.inputs.source-gitops.params.revision:-master)" ]; then
          git fetch 2>&1
          echo 'Creating and checking out branch $(inputs.params.GIT_BRANCH)'
          git checkout -q --track -b $(inputs.params.GIT_BRANCH) origin/$(inputs.params.GIT_BRANCH) 2>&1 || git checkout -q -b $(inputs.params.GIT_BRANCH) 2>&1
          git branch

          echo 'merging master into $(inputs.params.GIT_BRANCH)'
          git merge master 2>&1
        fi
    workingdir: /workspace/source-gitops
  - name: patch-imagetag
    image: mikefarah/yq:3.2.1
    script: |
        #!/usr/bin/env sh
        semver=$(cat /workspace/source-semver/components/iot-consumer/VERSION)
        echo $semver
        echo 'Patching $(inputs.params.RESOURCE_PATH)'
        echo ''
        cat $(inputs.params.RESOURCE_PATH)
        echo ''
        yq w -i $(inputs.params.RESOURCE_PATH) '$(inputs.params.YAML_PATH)' $semver
        echo ''
        cat $(inputs.params.RESOURCE_PATH)
    workingdir: /workspace/source-gitops
  - name: git-push
    image: alpine/git
    env:
      - name: GITHUB_TOKEN
        valueFrom:
          secretKeyRef:
            name: github
            key: token
      - name: GITHUB_USER
        valueFrom:
          secretKeyRef:
            name: github
            key: user      
    script: |
        #!/usr/bin/env sh
        echo "https://$GITHUB_USER:$GITHUB_TOKEN@github.com" > ~/.git-credentials
        git config --global credential.helper store 'store --file ~/.git-credentials'
        git config --global user.email "$(inputs.params.GIT_EMAIL)"
        git config --global user.name "$(inputs.params.GIT_USERNAME)"
        echo ''
        echo 'Adding $(inputs.params.RESOURCE_PATH) to git index'
        git add $(inputs.params.RESOURCE_PATH)
        git commit -m '$(inputs.params.GIT_COMMENT)'
        git push --set-upstream origin $(inputs.params.GIT_BRANCH)
    workingdir: /workspace/source-gitops 